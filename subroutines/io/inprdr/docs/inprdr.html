<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>inprdr.s</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl com">/**</span>
<span class="hl com"> * inprdr - Asks the user to input some value or string and stores it using malloc.</span>
<span class="hl com"> *</span>
<span class="hl com"> * &#64;return x0: Pointer to the input buffer.</span>
<span class="hl com"> *</span>
<span class="hl com"> * Registers used: x0, w8, lr</span>
<span class="hl com"> * Registers saved: lr</span>
<span class="hl com"> */</span>

<span class="hl ppc">.text</span>
<span class="hl ppc">.global inprdr</span>
    inprdr<span class="hl opt">:</span>
        <span class="hl opt">//</span> Save return address
        str <span class="hl kwb">lr</span><span class="hl opt">, [</span>sp<span class="hl opt">,</span> <span class="hl slc">#-16]!</span>

        <span class="hl opt">//</span> Read from stdin into <span class="hl kwa">a</span> buffer
        mov x0<span class="hl opt">,</span> <span class="hl slc">#0</span>
        ldr w8<span class="hl opt">, =</span><span class="hl num">1024</span>                    <span class="hl opt">//</span> Declare the buffer size <span class="hl num">1024</span>
        <span class="hl kwa">bl</span> malloc                        <span class="hl opt">//</span> Allocate memory <span class="hl kwa">and</span> get the pointer in x0
        str x0<span class="hl opt">, [</span>sp<span class="hl opt">,</span> <span class="hl slc">#-16]!              // Store the pointer on the stack</span>
        
        mov x2<span class="hl opt">,</span> <span class="hl slc">#1024                    // Set size of buffer</span>
        mov x8<span class="hl opt">,</span> <span class="hl slc">#63                      // Linux syscall number for read STDIN_FD</span>
        mov w1<span class="hl opt">,</span> w0                       <span class="hl opt">//</span> Move the malloc pointer into w1
        mov w0<span class="hl opt">,</span> <span class="hl slc">#0                       // STDIN_FD is file descriptor 0</span>
        <span class="hl kwa">svc</span> <span class="hl num">0</span>                            <span class="hl opt">//</span> Linux syscall to read from STDIN_FD
        
        ldr x0<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl slc">#16                // Retrieve the malloc pointer from stack</span>

        <span class="hl opt">//</span> Restore return address <span class="hl kwa">and</span> return
        ldr x30<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl slc">#16          </span>
        ret
</pre>
</body>
</html>
<!--HTML generated by highlight 3.41, http://www.andre-simon.de/-->
