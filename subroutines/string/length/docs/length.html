<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>length.s</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"> <span class="hl com">/**</span>
<span class="hl com"> * length - counts the number of characters in a string</span>
<span class="hl com"> * &#64;param x0: pointer to the string to count</span>
<span class="hl com"> * &#64;param x1: maximum number of characters to count</span>
<span class="hl com"> * &#64;return x0: number of characters counted, including null terminator</span>
<span class="hl com"> *</span>
<span class="hl com"> * This function counts the number of characters in a string pointed to by x0, up</span>
<span class="hl com"> * to a maximum of x1 characters. The count includes the null terminator. If the</span>
<span class="hl com"> * string is longer than x1 characters, the function stops counting at x1</span>
<span class="hl com"> * characters.</span>
<span class="hl com"> *</span>
<span class="hl com"> * Registers used: x0, x1, x2, x3, w3</span>
<span class="hl com"> * Registers saved: x19-x30, lr</span>
<span class="hl com"> */</span>

<span class="hl ppc">.text</span>
<span class="hl ppc">.global length</span>
    length<span class="hl opt">:</span>
        <span class="hl opt">//</span> Save registers x19 to x30
        <span class="hl opt">//</span>stp x29<span class="hl opt">,</span> x30<span class="hl opt">, [</span>sp<span class="hl opt">, -</span><span class="hl num">16</span><span class="hl opt">]!</span>
        <span class="hl opt">//</span> Setup the stack frame for strnlen
        <span class="hl opt">//</span>mov x29<span class="hl opt">,</span> sp

        <span class="hl opt">//</span> Save registers x19 to x29<span class="hl opt">,</span> <span class="hl kwa">and</span> the link register <span class="hl kwb">lr</span> on the stack
        stp x29<span class="hl opt">,</span> x30<span class="hl opt">, [</span>sp<span class="hl opt">, -</span><span class="hl num">16</span><span class="hl opt">]!</span>
        stp x19<span class="hl opt">,</span> x20<span class="hl opt">, [</span>sp<span class="hl opt">, -</span><span class="hl num">16</span><span class="hl opt">]!</span>
        stp x21<span class="hl opt">,</span> x22<span class="hl opt">, [</span>sp<span class="hl opt">, -</span><span class="hl num">16</span><span class="hl opt">]!</span>
        stp x23<span class="hl opt">,</span> x24<span class="hl opt">, [</span>sp<span class="hl opt">, -</span><span class="hl num">16</span><span class="hl opt">]!</span>
        stp x25<span class="hl opt">,</span> x26<span class="hl opt">, [</span>sp<span class="hl opt">, -</span><span class="hl num">16</span><span class="hl opt">]!</span>
        stp x27<span class="hl opt">,</span> x28<span class="hl opt">, [</span>sp<span class="hl opt">, -</span><span class="hl num">16</span><span class="hl opt">]!</span>
        stp x29<span class="hl opt">,</span> <span class="hl kwb">lr</span><span class="hl opt">, [</span>sp<span class="hl opt">, -</span><span class="hl num">16</span><span class="hl opt">]!</span>
        
        <span class="hl opt">//</span> Set up the stack frame for this function
        mov x29<span class="hl opt">,</span> sp

        <span class="hl opt">//</span> Move the maximum number of characters to count into x1
        mov x1<span class="hl opt">,</span> x2
        
        <span class="hl opt">//</span> Initialize the character count to zero
        mov x2<span class="hl opt">,</span> <span class="hl slc">#0</span>
    loop<span class="hl opt">:</span>
        <span class="hl opt">//</span> Load <span class="hl kwa">a</span> byte from the memory location pointed to by x0 with an offset of x2 <span class="hl kwa">and</span> store it in w3
        ldrb w3<span class="hl opt">, [</span>x0<span class="hl opt">,</span> x2<span class="hl opt">]</span>
        <span class="hl opt">//</span> Check if the byte we just loaded is zero <span class="hl opt">(</span>the null terminator<span class="hl opt">)</span>
        cbz w3<span class="hl opt">,</span> done
        <span class="hl opt">//</span> If the byte is <span class="hl kwa">not</span> zero<span class="hl opt">,</span> increment the character count
        <span class="hl kwa">add</span> x2<span class="hl opt">,</span> x2<span class="hl opt">,</span> <span class="hl slc">#1</span>
        <span class="hl opt">//</span> Check if we have counted the maximum number of characters
        <span class="hl kwa">cmp</span> x2<span class="hl opt">,</span> x1
        <span class="hl opt">//</span> If we have<span class="hl opt">,</span> we are done counting characters<span class="hl opt">,</span> so jump to the end of the function
        b.eq done
        <span class="hl opt">//</span> Otherwise<span class="hl opt">,</span> continue counting characters
        <span class="hl kwa">b</span> loop
        
    done<span class="hl opt">:</span>
        <span class="hl opt">//</span> Restore the saved registers x19 to x30 from the stack
        <span class="hl opt">//</span>ldp x29<span class="hl opt">,</span> x30<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl num">16</span>
        <span class="hl opt">//</span> Restore the saved registers x19 to x29<span class="hl opt">,</span> <span class="hl kwa">and</span> the link register <span class="hl kwb">lr</span> from the stack
        ldp x29<span class="hl opt">,</span> <span class="hl kwb">lr</span><span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl num">16</span>
        ldp x27<span class="hl opt">,</span> x28<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl num">16</span>
        ldp x25<span class="hl opt">,</span> x26<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl num">16</span>
        ldp x23<span class="hl opt">,</span> x24<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl num">16</span>
        ldp x21<span class="hl opt">,</span> x22<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl num">16</span>
        ldp x19<span class="hl opt">,</span> x20<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl num">16</span>
        ldp x29<span class="hl opt">,</span> x30<span class="hl opt">, [</span>sp<span class="hl opt">],</span> <span class="hl num">16</span>
        
        <span class="hl opt">//</span> Move the character count into x0 <span class="hl opt">(</span>the return value<span class="hl opt">)</span>
        mov x0<span class="hl opt">,</span> x2
        ret
</pre>
</body>
</html>
<!--HTML generated by highlight 3.41, http://www.andre-simon.de/-->
